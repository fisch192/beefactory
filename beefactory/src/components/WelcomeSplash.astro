---
// Welcome splash — immersive Three.js intro that recreates the BEE FACTORY logo
// Golden particles → honeycomb bars assemble → honey drop → bee flies in → text appears → dissolve
---

<div id="welcome-splash" class="fixed inset-0 z-[200] bg-[#0a0a0a]">
  <!-- Three.js canvas -->
  <canvas id="splash-canvas" class="absolute inset-0 w-full h-full"></canvas>

  <!-- Reduced-motion fallback: static logo -->
  <div id="splash-static" class="hidden absolute inset-0 flex flex-col items-center justify-center gap-4">
    <img
      src="/images/bee_factory_logo.svg"
      alt="BEE FACTORY"
      class="w-[clamp(160px,30vw,280px)] h-auto"
    />
    <span class="font-mono text-sm tracking-[0.3em] text-titanium font-bold uppercase">BEE FACTORY</span>
  </div>
</div>

<!-- Mini-replay canvas (hidden, reused on scroll-to-top) -->
<canvas id="replay-canvas" class="fixed inset-0 z-[199] w-full h-full pointer-events-none hidden"></canvas>

<style>
  #welcome-splash {
    pointer-events: all;
    transition: opacity 0.6s ease-out;
  }
</style>

<script>
  import { initSplashScene, playMiniReplay } from '../lib/three-splash';

  const splash = document.getElementById('welcome-splash');
  const canvas = document.getElementById('splash-canvas') as HTMLCanvasElement | null;
  const staticFallback = document.getElementById('splash-static');
  const replayCanvas = document.getElementById('replay-canvas') as HTMLCanvasElement | null;

  // Skip on return visit
  if (sessionStorage.getItem('beefactory-welcomed')) {
    splash?.remove();
  } else {
    sessionStorage.setItem('beefactory-welcomed', '1');

    const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    if (prefersReduced || !canvas) {
      // Static fallback: show logo briefly then fade
      if (canvas) canvas.style.display = 'none';
      if (staticFallback) staticFallback.classList.remove('hidden');
      setTimeout(() => {
        if (!splash) return;
        splash.style.opacity = '0';
        setTimeout(() => {
          window.dispatchEvent(new CustomEvent('beefactory:splash-fade'));
          splash.remove();
        }, 600);
      }, 1500);
    } else {
      // Three.js intro
      initSplashScene(
        canvas,
        () => {
          if (!splash) return;
          splash.style.opacity = '0';
          setTimeout(() => {
            window.dispatchEvent(new CustomEvent('beefactory:splash-fade'));
            splash.remove();
          }, 600);
        },
        '/images/bee_factory_logo.svg',
      );
    }
  }

  // Scroll-to-top mini replay
  let hasScrolledAway = false;
  let replayPlaying = false;

  const heroSection = document.querySelector('section'); // first section = hero

  if (heroSection && replayCanvas) {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (!entry.isIntersecting) {
            hasScrolledAway = true;
          } else if (hasScrolledAway && entry.isIntersecting && entry.intersectionRatio > 0.95 && !replayPlaying) {
            // Scrolled back to top
            hasScrolledAway = false;
            replayPlaying = true;
            replayCanvas.classList.remove('hidden');
            playMiniReplay(replayCanvas, () => {
              replayCanvas.classList.add('hidden');
              replayPlaying = false;
            });
          }
        });
      },
      { threshold: [0, 0.95] },
    );
    observer.observe(heroSection);
  }
</script>
