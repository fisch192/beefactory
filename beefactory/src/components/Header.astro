---
import type { Lang } from '../lib/i18n';
import { t } from '../lib/i18n';
import LanguageSwitcher from './LanguageSwitcher.astro';

interface Props {
  lang: Lang;
  hasHero?: boolean;
}

const { lang, hasHero = false } = Astro.props;
const prefix = `/${lang}`;
const catSlug = lang === 'de' ? 'kategorien' : 'categorie';

const navItems = [
  { href: `${prefix}/${catSlug}/startersets`,              label: t('nav.startersets', lang) },
  { href: `${prefix}/${catSlug}/bienenbeuten-zubehoer`,    label: t('nav.beuten', lang) },
  { href: `${prefix}/${catSlug}/werkzeuge-smoker`,         label: t('nav.werkzeuge', lang) },
  { href: `${prefix}/${catSlug}/schutz-kleidung`,          label: t('nav.schutz', lang) },
  { href: `${prefix}/${catSlug}/honigernte-verarbeitung`,  label: t('nav.honigernte', lang) },
  { href: `${prefix}/${lang === 'de' ? 'neuimker' : 'nuovi-apicoltori'}`, label: t('nav.neuimker', lang) },
];
---

<header id="site-header" class={`site-header${hasHero ? '' : ' scrolled'}`} data-has-hero={hasHero ? 'true' : 'false'}>
  <div class="header-inner">

    <!-- Logo -->
    <a href={`${prefix}/`} class="header-logo" aria-label="Bee Factory">
      <!-- White mark: shown on dark/transparent hero -->
      <img src="/images/logo-white.svg" alt="Bee Factory" class="logo-img logo-white" />
      <!-- Coloured mark: shown after scroll -->
      <img src="/images/logo.svg" alt="Bee Factory" class="logo-img logo-color" />
    </a>

    <!-- Desktop nav -->
    <nav class="header-nav" aria-label="Main navigation">
      {navItems.map((item) => (
        <a href={item.href} class="nav-link">{item.label}</a>
      ))}
    </nav>

    <!-- Actions -->
    <div class="header-actions">
      <LanguageSwitcher lang={lang} />

      <button id="cart-toggle" class="header-icon-btn" aria-label={t('nav.cart', lang)}>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
             fill="none" stroke="currentColor" stroke-width="1.5"
             stroke-linecap="round" stroke-linejoin="round">
          <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/>
          <line x1="3" y1="6" x2="21" y2="6"/>
          <path d="M16 10a4 4 0 01-8 0"/>
        </svg>
        <span id="cart-count" class="cart-badge hidden">0</span>
      </button>

      <!-- Mobile menu toggle -->
      <button id="mobile-menu-toggle" class="header-icon-btn xl:hidden"
              aria-label="Menu" aria-expanded="false">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"
             fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
             class="menu-open">
          <line x1="3" y1="7"  x2="21" y2="7"/>
          <line x1="3" y1="12" x2="21" y2="12"/>
          <line x1="3" y1="17" x2="21" y2="17"/>
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"
             fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
             class="menu-close hidden">
          <line x1="18" y1="6"  x2="6"  y2="18"/>
          <line x1="6"  y1="6"  x2="18" y2="18"/>
        </svg>
      </button>
    </div>

  </div>
</header>

<!-- Mobile drawer -->
<div id="mobile-menu" class="mobile-menu hidden" aria-hidden="true">
  <nav class="mobile-nav">
    {navItems.map((item) => (
      <a href={item.href} class="mobile-nav-link">{item.label}</a>
    ))}
    <a href={`${prefix}/${lang === 'de' ? 'ueber-uns' : 'chi-siamo'}`}
       class="mobile-nav-link opacity-60">{t('nav.about', lang)}</a>
  </nav>
</div>

<style>
  /* ── Shell ─────────────────────────────────── */
  .site-header {
    position:   fixed;
    top:        0;
    left:       0;
    right:      0;
    z-index:    100;
    transition:
      background   0.45s cubic-bezier(0.16, 1, 0.3, 1),
      box-shadow   0.45s cubic-bezier(0.16, 1, 0.3, 1);
  }

  /* ── Header transitions ────────────────────── */
  /* On dark hero: transparent + white text */
  .site-header {
    background:     transparent;
    --hdr-fg:       rgba(255, 255, 255, 0.85);
    --hdr-fg-hover: rgba(255, 255, 255, 1);
  }

  /* Scrolled: cream bg + dark text */
  .site-header.scrolled {
    background:            rgba(250, 247, 242, 0.96);
    backdrop-filter:       blur(16px);
    -webkit-backdrop-filter: blur(16px);
    box-shadow:            0 1px 0 rgba(0, 0, 0, 0.06);
    --hdr-fg:              rgba(30, 27, 20, 0.85);
    --hdr-fg-hover:        var(--color-obsidian);
  }

  /* ── Inner container ───────────────────────── */
  .header-inner {
    max-width: 1440px;
    margin:    0 auto;
    padding:   0 clamp(1.25rem, 5vw, 4rem);
    height:    5rem;
    display:   flex;
    align-items: center;
    justify-content: space-between;
    gap:       2rem;
  }

  /* ── Logo ──────────────────────────────────── */
  .header-logo {
    position:    relative;
    flex-shrink: 0;
    line-height: 0;
    transition:  opacity 0.25s;
  }
  .header-logo:hover { opacity: 0.8; }

  .logo-img {
    height:     2.75rem;
    width:      auto;
    transition: opacity 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }

  /* Transparent header: white logo on, golden off */
  .logo-white { opacity: 1; }
  .logo-color { opacity: 0; position: absolute; top: 0; left: 0; pointer-events: none; }

  /* Scrolled header: golden logo on, white off */
  .site-header.scrolled .logo-white { opacity: 0; pointer-events: none; }
  .site-header.scrolled .logo-color { opacity: 1; pointer-events: auto; }

  /* ── Desktop nav ───────────────────────────── */
  .header-nav {
    display:  none;
    align-items: center;
    gap:      2rem;
  }
  @media (min-width: 1280px) {
    .header-nav { display: flex; }
  }

  .nav-link {
    position:        relative;
    font-size:       0.8125rem;
    font-weight:     450;
    letter-spacing:  0.02em;
    color:           var(--hdr-fg);
    text-decoration: none;
    padding-bottom:  2px;
    white-space:     nowrap;
    transition:      color 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }
  .nav-link::after {
    content:    '';
    position:   absolute;
    bottom:     0;
    left:       0;
    width:      100%;
    height:     1px;
    background: var(--color-gold);
    transform:  scaleX(0);
    transform-origin: right;
    transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
  }
  .nav-link:hover {
    color: var(--hdr-fg-hover);
  }
  .nav-link:hover::after {
    transform:        scaleX(1);
    transform-origin: left;
  }

  /* ── Actions ───────────────────────────────── */
  .header-actions {
    display:     flex;
    align-items: center;
    gap:         0.5rem;
    flex-shrink: 0;
  }

  .header-icon-btn {
    position:   relative;
    display:    flex;
    align-items: center;
    justify-content: center;
    width:      2.5rem;
    height:     2.5rem;
    background: none;
    border:     none;
    cursor:     pointer;
    color:      var(--hdr-fg);
    transition: color 0.2s;
    border-radius: 0;
  }
  .header-icon-btn:hover { color: var(--hdr-fg-hover); }

  /* ── Cart badge ────────────────────────────── */
  .cart-badge {
    position:    absolute;
    top:         0.2rem;
    right:       0.2rem;
    background:  var(--color-gold);
    color:       var(--color-obsidian);
    font-size:   0.6rem;
    font-weight: 700;
    width:       1.1rem;
    height:      1.1rem;
    border-radius: 50%;
    display:     flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
  }
  .cart-badge.hidden { display: none; }

  /* ── Mobile drawer ─────────────────────────── */
  .mobile-menu {
    position:   fixed;
    top:        5rem;
    left:       0;
    right:      0;
    bottom:     0;
    background: var(--color-obsidian);
    z-index:    99;
    overflow-y: auto;
  }
  .mobile-menu.hidden { display: none; }

  .mobile-nav {
    display:        flex;
    flex-direction: column;
    padding:        2rem clamp(1.25rem, 5vw, 4rem);
    gap:            0;
  }
  .mobile-nav-link {
    font-size:       1.5rem;
    font-family:     var(--font-display);
    font-weight:     300;
    letter-spacing:  -0.02em;
    color:           rgba(255, 255, 255, 0.85);
    text-decoration: none;
    padding:         1.1rem 0;
    border-bottom:   1px solid rgba(255, 255, 255, 0.06);
    transition:      color 0.35s cubic-bezier(0.16, 1, 0.3, 1),
                     letter-spacing 0.35s cubic-bezier(0.16, 1, 0.3, 1);
  }
  .mobile-nav-link:hover {
    color:           var(--color-gold);
    letter-spacing:  -0.01em;
  }
</style>

<script>
  const header = document.getElementById('site-header');
  const toggle = document.getElementById('mobile-menu-toggle');
  const menu   = document.getElementById('mobile-menu');
  const openIc = toggle?.querySelector('.menu-open');
  const closeIc = toggle?.querySelector('.menu-close');

  /* Scrolled state — only animate on hero pages */
  const hasHero = header?.dataset.hasHero === 'true';
  function onScroll() {
    if (hasHero) {
      header?.classList.toggle('scrolled', window.scrollY > 60);
    }
  }
  window.addEventListener('scroll', onScroll, { passive: true });

  /* Mobile menu */
  toggle?.addEventListener('click', () => {
    const isOpen = !menu?.classList.contains('hidden');
    menu?.classList.toggle('hidden');
    menu?.setAttribute('aria-hidden', String(isOpen));
    openIc?.classList.toggle('hidden');
    closeIc?.classList.toggle('hidden');
    toggle.setAttribute('aria-expanded', String(!isOpen));
    document.body.style.overflow = isOpen ? '' : 'hidden';
  });

  /* Cart badge */
  function updateCart() {
    try {
      const stored = localStorage.getItem('beefactory-cart');
      const cart = stored ? JSON.parse(stored) : { items: [] };
      const n = cart.items.reduce((s: number, i: { quantity: number }) => s + i.quantity, 0);
      const badge = document.getElementById('cart-count');
      if (badge) {
        badge.textContent = String(n);
        badge.classList.toggle('hidden', n === 0);
      }
    } catch { /* ignore */ }
  }
  updateCart();
  window.addEventListener('cart-updated', updateCart);
</script>
