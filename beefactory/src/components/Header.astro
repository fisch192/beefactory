---
import type { Lang } from '../lib/i18n';
import { t } from '../lib/i18n';
import LanguageSwitcher from './LanguageSwitcher.astro';

interface Props {
  lang: Lang;
  hasHero?: boolean;
}

const { lang, hasHero = false } = Astro.props;
const prefix = `/${lang}`;
const catSlug = lang === 'de' ? 'kategorien' : 'categorie';

const navItems = [
  { href: `${prefix}/${catSlug}/startersets`,              label: t('nav.startersets', lang) },
  { href: `${prefix}/${catSlug}/bienenbeuten-zubehoer`,    label: t('nav.beuten', lang) },
  { href: `${prefix}/${catSlug}/werkzeuge-smoker`,         label: t('nav.werkzeuge', lang) },
  { href: `${prefix}/${catSlug}/schutz-kleidung`,          label: t('nav.schutz', lang) },
  { href: `${prefix}/${catSlug}/honigernte-verarbeitung`,  label: t('nav.honigernte', lang) },
  { href: `${prefix}/${lang === 'de' ? 'neuimker' : 'nuovi-apicoltori'}`, label: t('nav.neuimker', lang) },
];
---

<header id="site-header" class={`site-header${hasHero ? '' : ' scrolled'}`} data-has-hero={hasHero ? 'true' : 'false'}>
  <div class="header-inner">

    <!-- Logo -->
    <a href={`${prefix}/`} class="header-logo" aria-label="Beefactory">
      <!-- We use the precise, uploaded hexagon logo -->
      <img src="/images/logook.png" alt="Beefactory" class="logo-img" />
    </a>

    <!-- Desktop nav (JetBrains Mono) -->
    <nav class="header-nav font-sans uppercase tracking-[0.05em] text-sm font-medium" aria-label="Main navigation">
      {navItems.map((item) => (
        <a href={item.href} class="nav-link">{item.label}</a>
      ))}
    </nav>

    <!-- Actions -->
    <div class="header-actions">
      <LanguageSwitcher lang={lang} />

      <button id="cart-toggle" class="header-icon-btn group" aria-label={t('nav.cart', lang)}>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
             fill="none" stroke="currentColor" stroke-width="1.5"
             stroke-linecap="square" stroke-linejoin="miter" class="transition-transform group-hover:scale-110">
          <path d="M6 2L3 6v14h18V6l-3-4z"/>
          <line x1="3" y1="6" x2="21" y2="6"/>
          <!-- Sharp corners, removed rounded ends -->
          <path d="M16 10v2a4 4 0 01-8 0v-2" />
        </svg>
        <span id="cart-count" class="cart-badge hidden font-mono">0</span>
      </button>

      <!-- Mobile menu toggle -->
      <button id="mobile-menu-toggle" class="header-icon-btn xl:hidden"
              aria-label="Menu" aria-expanded="false">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"
             fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="square"
             class="menu-open">
          <line x1="3" y1="7"  x2="21" y2="7"/>
          <line x1="3" y1="12" x2="21" y2="12"/>
          <line x1="3" y1="17" x2="21" y2="17"/>
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"
             fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="square"
             class="menu-close hidden">
          <line x1="18" y1="6"  x2="6"  y2="18"/>
          <line x1="6"  y1="6"  x2="18" y2="18"/>
        </svg>
      </button>
    </div>

  </div>
</header>

<!-- Mobile drawer -->
<div id="mobile-menu" class="mobile-menu hidden" aria-hidden="true">
  <nav class="mobile-nav">
    {navItems.map((item) => (
      <a href={item.href} class="mobile-nav-link font-sans uppercase tracking-widest">{item.label}</a>
    ))}
    <a href={`${prefix}/${lang === 'de' ? 'ueber-uns' : 'chi-siamo'}`}
       class="mobile-nav-link opacity-60 font-sans uppercase tracking-widest">{t('nav.about', lang)}</a>
  </nav>
</div>

<style>
  /* ── Shell ─────────────────────────────────── */
  .site-header {
    position:   fixed;
    top:        0;
    left:       0;
    right:      0;
    z-index:    100;
    background: transparent;
    --hdr-fg:   var(--color-titanium);
    --hdr-fg-hover: var(--color-amber);
    transition:
      background   0.3s cubic-bezier(0.16, 1, 0.3, 1),
      box-shadow   0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }

  /* Scrolled: Machined Charcoal bg */
  .site-header.scrolled {
    background:            rgba(28, 28, 30, 0.85); /* Machined Charcoal */
    backdrop-filter:       blur(24px);
    -webkit-backdrop-filter: blur(24px);
    box-shadow:            0 1px 0 rgba(255, 255, 255, 0.05); /* Harsh highlight */
  }

  /* ── Inner container ───────────────────────── */
  .header-inner {
    max-width: 1440px;
    margin:    0 auto;
    padding:   0 clamp(1.5rem, 5vw, 5rem);
    height:    5.5rem;
    display:   flex;
    align-items: center;
    justify-content: space-between;
    gap:       2rem;
  }

  /* ── Logo ──────────────────────────────────── */
  .header-logo {
    position:    relative;
    flex-shrink: 0;
    line-height: 0;
    transition:  transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }
  .header-logo:hover {
    transform: scale(0.95);
  }

  .logo-img {
    height:     3rem;
    width:      auto;
    object-fit: contain;
  }

  /* ── Desktop nav ───────────────────────────── */
  .header-nav {
    display:  none;
    align-items: center;
    gap:      2.5rem;
  }
  @media (min-width: 1280px) {
    .header-nav { display: flex; }
  }

  .nav-link {
    position:        relative;
    color:           var(--hdr-fg);
    text-decoration: none;
    padding-bottom:  4px;
    white-space:     nowrap;
    transition:      color 0.2s;
  }
  .nav-link::after {
    content:    '';
    position:   absolute;
    bottom:     0;
    left:       50%;
    width:      100%;
    height:     1px;
    background: var(--color-amber);
    transform:  translateX(-50%) scaleX(0);
    transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }
  .nav-link:hover {
    color: var(--hdr-fg-hover);
  }
  .nav-link:hover::after {
    transform: translateX(-50%) scaleX(1);
  }

  /* ── Actions ───────────────────────────────── */
  .header-actions {
    display:     flex;
    align-items: center;
    gap:         1rem;
    flex-shrink: 0;
  }

  .header-icon-btn {
    position:   relative;
    display:    flex;
    align-items: center;
    justify-content: center;
    width:      2.5rem;
    height:     2.5rem;
    background: none;
    border:     none;
    cursor:     pointer;
    color:      var(--hdr-fg);
    transition: color 0.2s;
    border-radius: 0;
  }
  .header-icon-btn:hover { color: var(--hdr-fg-hover); }

  /* ── Cart badge ────────────────────────────── */
  .cart-badge {
    position:    absolute;
    top:         0;
    right:       0;
    background:  var(--color-amber);
    color:       var(--color-void);
    font-size:   0.65rem;
    font-weight: 700;
    width:       1.25rem;
    height:      1.25rem;
    border-radius: 0; /* Boxy */
    display:     flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
  }
  .cart-badge.hidden { display: none; }

  /* ── Mobile drawer ─────────────────────────── */
  .mobile-menu {
    position:   fixed;
    top:        5.5rem;
    left:       0;
    right:      0;
    bottom:     0;
    background: var(--color-void);
    z-index:    99;
    overflow-y: auto;
  }
  .mobile-menu.hidden { display: none; }

  .mobile-nav {
    display:        flex;
    flex-direction: column;
    padding:        2rem clamp(1.5rem, 5vw, 5rem);
    gap:            0;
  }
  .mobile-nav-link {
    font-size:       1.125rem;
    color:           var(--color-titanium);
    text-decoration: none;
    padding:         1.25rem 0;
    border-bottom:   1px solid var(--color-machined);
    transition:      color 0.2s, padding-left 0.2s;
  }
  .mobile-nav-link:hover {
    color:           var(--color-amber);
    padding-left:    0.5rem;
  }
</style>

<script>
  const header = document.getElementById('site-header');
  const toggle = document.getElementById('mobile-menu-toggle');
  const menu   = document.getElementById('mobile-menu');
  const openIc = toggle?.querySelector('.menu-open');
  const closeIc = toggle?.querySelector('.menu-close');

  /* Scrolled state — only animate on hero pages */
  const hasHero = header?.dataset.hasHero === 'true';
  function onScroll() {
    if (hasHero) {
      header?.classList.toggle('scrolled', window.scrollY > 60);
    }
  }
  window.addEventListener('scroll', onScroll, { passive: true });

  /* Mobile menu */
  toggle?.addEventListener('click', () => {
    const isOpen = !menu?.classList.contains('hidden');
    menu?.classList.toggle('hidden');
    menu?.setAttribute('aria-hidden', String(isOpen));
    openIc?.classList.toggle('hidden');
    closeIc?.classList.toggle('hidden');
    toggle.setAttribute('aria-expanded', String(!isOpen));
    document.body.style.overflow = isOpen ? '' : 'hidden';
  });

  /* Cart badge */
  function updateCart() {
    try {
      const stored = localStorage.getItem('beefactory-cart');
      const cart = stored ? JSON.parse(stored) : { items: [] };
      const n = cart.items.reduce((s: number, i: { quantity: number }) => s + i.quantity, 0);
      const badge = document.getElementById('cart-count');
      if (badge) {
        badge.textContent = String(n);
        badge.classList.toggle('hidden', n === 0);
      }
    } catch { /* ignore */ }
  }
  updateCart();
  window.addEventListener('cart-updated', updateCart);
</script>
