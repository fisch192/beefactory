---
import type { Collection } from '../data/collections';
import type { Lang } from '../lib/i18n';
import { t } from '../lib/i18n';
import { getProductsByCollection } from '../data/products';

interface Props {
  collection: Collection;
  lang:       Lang;
  size?:      'normal' | 'large';
}

const { collection, lang, size = 'normal' } = Astro.props;
const prefix       = `/${lang}`;
const catSlug      = lang === 'de' ? 'kategorien' : 'categorie';
const productCount = getProductsByCollection(collection.handle).length;
---

<a
  href={`${prefix}/${catSlug}/${collection.handle}`}
  class:list={['cat-card fade-in', size === 'large' ? 'cat-card--large' : '']}
>
  <!-- Background image or gradient placeholder -->
  {collection.image ? (
    <img src={collection.image} alt="" class="cat-bg-img" loading="lazy" aria-hidden="true" />
  ) : (
    <div class="cat-bg-placeholder" aria-hidden="true">
      <!-- Subtle hex pattern -->
      <svg class="cat-hex-bg" xmlns="http://www.w3.org/2000/svg" width="100%" height="100%">
        <defs>
          <pattern id={`hp-${collection.handle}`} width="70" height="121"
                   patternUnits="userSpaceOnUse">
            <path d="M35 0L70 20.2V60.8L35 81L0 60.8V20.2L35 0Z
                     M35 81L70 101.2V141.8L35 162L0 141.8V101.2L35 81Z"
                  fill="none" stroke="#C49A3C" stroke-width="0.5"/>
          </pattern>
        </defs>
        <rect width="100%" height="100%" fill={`url(#hp-${collection.handle})`}/>
      </svg>
    </div>
  )}

  <!-- Dark gradient overlay -->
  <div class="cat-overlay" aria-hidden="true"></div>

  <!-- Content -->
  <div class="cat-content">
    <p class="cat-count">
      {productCount}&nbsp;{lang === 'de' ? 'Produkte' : 'Prodotti'}
    </p>

    <h3 class:list={['cat-name', size === 'large' ? 'cat-name--large' : '']}>
      {collection.title[lang]}
    </h3>

    <span class="cat-cta">
      {t('categories.view', lang)}
      <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24"
           fill="none" stroke="currentColor" stroke-width="2.5"
           stroke-linecap="round" stroke-linejoin="round" class="cat-arrow">
        <polyline points="9 18 15 12 9 6"/>
      </svg>
    </span>
  </div>

</a>

<style>
  /* ── Card base ─────────────────────────────── */
  .cat-card {
    position:        relative;
    display:         block;
    overflow:        hidden;
    text-decoration: none;
    background:      var(--color-void);
    aspect-ratio:    4 / 3;
    border:          1px solid var(--color-machined);
    transition:      border-color 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }
  .cat-card:hover {
    border-color:    var(--color-amber);
  }

  /* Large variant spans 2 rows in the grid */
  .cat-card--large {
    aspect-ratio: unset;
  }
  @media (min-width: 1024px) {
    .cat-card--large {
      grid-row: span 2;
    }
  }

  /* ── Background ────────────────────────────── */
  .cat-bg-img {
    position:    absolute;
    inset:       0;
    width:       100%;
    height:      100%;
    object-fit:  cover;
    will-change: transform;
    transition:  transform 0.8s cubic-bezier(0.16, 1, 0.3, 1);
  }
  .cat-card:hover .cat-bg-img {
    transform: scale(1.06);
  }

  .cat-bg-placeholder {
    position:   absolute;
    inset:      0;
    background: var(--color-machined);
  }
  .cat-hex-bg {
    position: absolute;
    inset:    0;
    opacity:  0.2;
    color:    var(--color-steel);
    transition: color 0.3s;
  }
  .cat-card:hover .cat-hex-bg {
    color: var(--color-amber);
  }

  /* ── Overlay ───────────────────────────────── */
  .cat-overlay {
    position:   absolute;
    inset:      0;
    background: linear-gradient(
      to top,
      rgba(10, 10, 10, 0.95) 0%,
      rgba(10, 10, 10, 0.5)  45%,
      rgba(10, 10, 10, 0.1)  100%
    );
    transition: background 0.35s;
    pointer-events: none;
  }
  .cat-card:hover .cat-overlay {
    background: linear-gradient(
      to top,
      rgba(10, 10, 10, 0.98) 0%,
      rgba(10, 10, 10, 0.6)  50%,
      rgba(10, 10, 10, 0.2) 100%
    );
  }

  /* ── Content ───────────────────────────────── */
  .cat-content {
    position: absolute;
    bottom:   0;
    left:     0;
    right:    0;
    padding:  1.5rem clamp(1.25rem, 3vw, 2rem);
    z-index:  2;
  }

  .cat-count {
    font-size:      0.65rem;
    font-weight:    700;
    font-family:    var(--font-sans);
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color:          var(--color-steel);
    margin-bottom:  0.5rem;
  }

  .cat-name {
    font-family:    var(--font-display);
    font-weight:    400;
    font-size:      clamp(1.5rem, 3vw, 2rem);
    letter-spacing: -0.02em;
    color:          var(--color-titanium);
    margin-bottom:  1rem;
    line-height:    1.1;
    transition:     color 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }
  .cat-name--large {
    font-size: clamp(2rem, 4vw, 3rem);
  }
  .cat-card:hover .cat-name { color: var(--color-amber); }

  .cat-cta {
    display:        inline-flex;
    align-items:    center;
    gap:            0.5rem;
    font-size:      0.75rem;
    font-family:    var(--font-sans);
    font-weight:    700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color:          var(--color-steel);
    transition:     color 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }
  .cat-card:hover .cat-cta { color: var(--color-amber); }

  .cat-arrow {
    transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }
  .cat-card:hover .cat-arrow { transform: translateX(5px); }
</style>
