---
export const prerender = true;
import ShopLayout from '../../../layouts/ShopLayout.astro';
import AddToCart from '../../../components/cart/AddToCart';
import CartDrawer from '../../../components/cart/CartDrawer';
import { t } from '../../../lib/i18n';
import { formatPrice } from '../../../lib/utils';
import { getProducts, getProduct } from '../../../data/products';
import { getCollectionByHandle } from '../../../data/collections';

export async function getStaticPaths() {
  const products = await getProducts();
  return products.map((p) => ({ params: { handle: p.handle } }));
}

const lang = 'it';
const { handle } = Astro.params;
const product = await getProduct(handle!);
if (!product) return Astro.redirect('/it/');

const collection = getCollectionByHandle(product.collection);
const imgSlug = collection?.handle?.split('-')[0];
const catImage = imgSlug ? `/images/cat-${imgSlug}.jpg` : '/images/hero-bg.jpg';
---

<ShopLayout
  lang={lang}
  title={product.title[lang]}
  description={product.description[lang]}
  canonicalPath={`/it/prodotti/${handle}`}
>

  <section class="pd-banner">
    <img src={catImage} alt="" class="pd-banner-img" aria-hidden="true" />
    <div class="pd-banner-overlay"></div>
    <div class="pd-banner-body">
      <nav class="pd-breadcrumb">
        <a href="/it/">Home</a>
        <span>/</span>
        {collection && <><a href={`/it/categorie/${collection.handle}`}>{collection.title[lang]}</a><span>/</span></>}
        <span>{product.title[lang]}</span>
      </nav>
    </div>
  </section>

  <section class="pd-section">
    <div class="container-wide">
      <div class="pd-grid">
        <div class="pd-image-wrap fade-in">
          <div class="pd-image-inner">
            <div class="pd-image-bg">
              <span class="pd-image-text">{product.title[lang]}</span>
            </div>
            {product.tags.includes('bestseller') && (
              <span class="pd-badge">Bestseller</span>
            )}
          </div>
        </div>

        <div class="pd-info fade-in">
          {collection && (
            <span class="eyebrow" style="margin-bottom:1rem;display:block">
              {collection.title[lang]}
            </span>
          )}
          <h1 class="pd-title">{product.title[lang]}</h1>
          <p class="pd-price">{formatPrice(product.price)}</p>
          <p class="pd-desc">{product.description[lang]}</p>

          <div class="pd-cta">
            <AddToCart
              client:load
              productId={product.id}
              productTitle={product.title[lang]}
              variants={product.variants}
              buttonText={t('product.addToCart', lang)}
              outOfStockText={t('product.outOfStock', lang)}
              variantLabel={product.variants.length > 1 ? t('product.variant', lang) : undefined}
            />
          </div>

          <div class="pd-usps">
            <div class="pd-usp">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
              Spedizione gratuita da 300 EUR
            </div>
            <div class="pd-usp">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
              Qualit√† garantita dall'Alto Adige
            </div>
            <div class="pd-usp">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
              Consulenza personale
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <CartDrawer
    client:load
    title={t('cart.title', lang)}
    emptyText={t('cart.empty', lang)}
    totalText={t('cart.total', lang)}
    checkoutText={t('cart.checkout', lang)}
    continueText={t('cart.continue', lang)}
    removeText={t('cart.remove', lang)}
  />
</ShopLayout>

<style>
  .pd-banner {
    position: relative; height: clamp(10rem,22vw,18rem);
    overflow: hidden; display: flex; align-items: flex-end;
  }
  .pd-banner-img {
    position: absolute; inset: 0; width: 100%; height: 100%;
    object-fit: cover; filter: brightness(0.4) saturate(0.7);
  }
  .pd-banner-overlay {
    position: absolute; inset: 0;
    background: linear-gradient(to top, rgba(13,12,10,0.9) 0%, rgba(13,12,10,0.2) 100%);
  }
  .pd-banner-body {
    position: relative; z-index: 2; width: 100%;
    padding: 0 clamp(1.25rem,5vw,4rem) 2rem;
    max-width: 1440px; margin: 0 auto;
  }
  .pd-breadcrumb {
    display: flex; align-items: center; gap: 0.5rem;
    font-size: 0.6875rem; font-weight: 500; letter-spacing: 0.12em;
    text-transform: uppercase; color: rgba(255,255,255,0.4);
  }
  .pd-breadcrumb a { color: rgba(255,255,255,0.4); text-decoration: none; transition: color 0.2s; }
  .pd-breadcrumb a:hover { color: rgba(255,255,255,0.8); }
  .pd-section {
    background: var(--color-cream);
    padding-top: clamp(3rem,6vw,5rem); padding-bottom: clamp(4rem,8vw,8rem);
  }
  .pd-grid { display: grid; grid-template-columns: 1fr; gap: 3rem; }
  @media (min-width: 1024px) { .pd-grid { grid-template-columns: 1fr 1fr; gap: 5rem; align-items: start; } }
  .pd-image-inner { position: relative; aspect-ratio: 1; background: var(--color-warm); overflow: hidden; }
  .pd-image-bg { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; padding: 2rem; }
  .pd-image-text {
    font-family: var(--font-display); font-size: clamp(1.5rem,4vw,3rem);
    font-weight: 300; letter-spacing: -0.02em;
    color: rgba(13,12,10,0.08); text-align: center; line-height: 1.1; text-transform: uppercase;
  }
  .pd-badge {
    position: absolute; top: 1.25rem; left: 1.25rem;
    background: var(--color-gold); color: var(--color-obsidian);
    font-size: 0.625rem; font-weight: 700; letter-spacing: 0.15em;
    text-transform: uppercase; padding: 0.35rem 0.75rem;
  }
  .pd-title {
    font-family: var(--font-display); font-size: clamp(1.75rem,4vw,3rem);
    font-weight: 300; letter-spacing: -0.02em; line-height: 1.05;
    color: var(--color-ink); margin-bottom: 1rem;
  }
  .pd-price { font-size: 1.75rem; font-weight: 600; color: var(--color-ink); letter-spacing: -0.01em; margin-bottom: 1.5rem; }
  .pd-desc { font-size: 1rem; color: var(--color-ash); line-height: 1.75; margin-bottom: 2rem; }
  .pd-cta { margin-bottom: 2.5rem; }
  .pd-usps { display: flex; flex-direction: column; gap: 0.875rem; padding-top: 2rem; border-top: 1px solid var(--color-warm-dark); }
  .pd-usp { display: flex; align-items: center; gap: 0.75rem; font-size: 0.875rem; color: var(--color-ash); }
  .pd-usp svg { color: var(--color-gold); flex-shrink: 0; }
</style>
